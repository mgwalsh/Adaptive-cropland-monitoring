# Spatial predictions of management responses {#mrt}

*Edited by: Jordan Chamberlin, Markus Walsh, ...?*

## Introduction {#mrt-intro}

An ability to track changes and anticipate the attendant impacts requires reliable spatial information about the characteristics and distribution of cropland productivity and their potentials for improvement, in context of the relevant interventions and/or existing practices. 

The most reliable and informative way of evaluating the efficacy and impact of management interventions is to use [**Randomized Controlled Trials**](https://en.wikipedia.org/wiki/Randomized_controlled_trial) (RCTs). RCTs compare interventions(s) against at least one common control at the same location and time. *"Randomized"* in this context simply means having multiple individual locations (sometimes hundreds or even thousands) that are subjected to the same control and intervention arms and that those locations are selected randomly from within a given region of interest (ROI). The main problems with all RCTs in agriculture is that they are usually logistically difficult and quite expensive to conduct *"at scale"*. RCTs at scale typically require moving toward collaborative working approaches and models. One of the potential advantages of this is the ability to build on the strengths of common data collection and analysis protocols and to share workloads.

Agricultural development projects also frequently carry out regular monitoring and evaluation surveys to gauge impacts or to adjust management interventions where needed. More generally, these are known as [**Observational Surveys**](https://en.wikipedia.org/wiki/Observational_study), which can be applied in various configurations. Although observational surveys generally cannot be used to make definitive statements about the *"effectiveness"* of a management practice, they are used to provide information on *“real world”* use and to detect signals about where the benefits and risks of using of those practices occur in agricultural landscapes. They also tend to be much cheaper than RCTs per unit effort.

This chapter provides worked examples of both RCTs and Observational Surveys.

## Nigeria fertilizer response data {#NG-data}

```{r}
# install.packages(c("downloader","rgdal","raster","arm","leaflet","htmlwidgets")), dependencies=TRUE)
suppressPackageStartupMessages({
  require(downloader)
  require(rgdal)
  require(sp)
  require(raster)
  require(arm)
  require(leaflet)
  require(htmlwidgets)
})
```

```{r}
# Data downloads -----------------------------------------------------------
# download IITA/OCP yield data
download("https://www.dropbox.com/s/hi75cnp3ejr4srk/OCP_trials.zip?raw=1", "OCP_trials.zip", mode = "wb")
unzip("OCP_trials.zip", overwrite = T)
sites <- read.table("sites.csv", header=T, sep=",")
trial <- read.table("trials.csv", header=T, sep=",")
tresp <- merge(sites, trial, by="sid")

# download GADM-L2 shapefile (courtesy: http://www.gadm.org)
download("https://www.dropbox.com/s/y3h6l7yu00orm78/NGA_adm2.zip?raw=1", "NGA_adm2.zip", mode = "wb")
unzip("NGA_adm2.zip", overwrite = T)
shape <- shapefile("NGA_adm2.shp")

# download raster stack (note this is a big 800+ Mb download)
download("https://www.dropbox.com/s/u5fyjbujf0d7q43/NG_250m_2017.zip?raw=1", "NG_250m_2017.zip", mode = "wb")
unzip("NG_250m_2017.zip", overwrite = T)
glist <- list.files(pattern="tif", full.names = T)
grids <- stack(glist)

# Data setup --------------------------------------------------------------
# attach GADM-L2 admin unit names from shape
coordinates(tresp) <- ~lon+lat
projection(tresp) <- projection(shape)
gadm <- tresp %over% shape
tresp <- as.data.frame(tresp)
tresp <- cbind(gadm[ ,c(5,7)], tresp)
colnames(tresp) <- c("state","lga","sid","lat","lon","alt","team","trt","ccob","tcob","twgt","cyld","tyld","ayld")

# project survey coords to grid CRS
tresp.proj <- as.data.frame(project(cbind(tresp$lon, tresp$lat), "+proj=laea +ellps=WGS84 +lon_0=20 +lat_0=5 +units=m +no_defs"))
colnames(tresp.proj) <- c("x","y")
tresp <- cbind(tresp, tresp.proj)
coordinates(tresp) <- ~x+y
projection(tresp) <- projection(tresp)

# extract gridded variables at survey locations
trespgrid <- extract(grids, tresp)
gsdat <- as.data.frame(cbind(tresp, trespgrid)) 
# plot(alt~MDEM, gsdat) ## gps altitude/location check against MDEM 
```

```{r}
# Classify by site indices ------------------------------------------------
si.lmer <- lmer(log(tyld)~trt*+(1|sid), gsdat) ## random intercept (site-level) model
display(si.lmer)
si.ran <- ranef(si.lmer) ## extract random effects
si <- as.data.frame(rownames(si.ran$sid))
si$si <- si.ran$sid[,1]
colnames(si) <- c("sid","si")
si$sic <- ifelse(si$si > 0, "A", "B") ## classify above/below average site indices (sic = A or B)
gsdat <- merge(gsdat, si, by="sid")
si <- merge(si, sites, by="sid")

# Plots
boxplot(tyld~trt, notch=T, ylab="Cob yield (kg/ha)", ylim=c(0,8000), gsdat) ## treatment differences
boxplot(tyld~sic, notch=T, ylab="Cob yield (kg/ha)", ylim=c(0,8000), gsdat) ## yield differences between site index classes
boxplot(tcob~trt*sic, notch=T, ylab="Number of cobs", ylim=c(0,800), gsdat) ## treatment differences
boxplot(tyld~trt*sic, notch=T, ylab="Cob yield (kg/ha)", ylim=c(0,8000), gsdat) ## treatment differences
plot(tyld~cyld, xlab="Maize yield (kg/ha), circular plot", ylab="Maize yield (kg/ha), total plot", gsdat)

# extract gridded variables at trial locations
si.proj <- as.data.frame(project(cbind(si$lon, si$lat), "+proj=laea +ellps=WGS84 +lon_0=20 +lat_0=5 +units=m +no_defs"))
colnames(si.proj) <- c("x","y")
si <- cbind(si, si.proj)
coordinates(si) <- ~x+y
projection(si) <- projection(tresp)
sigrid <- extract(grids, si)
sidat <- as.data.frame(cbind(si, sigrid)) 
```

```{r}
# Write data frames -------------------------------------------------------
dir.create("Results", showWarnings = F)
write.csv(gsdat, "./Results/OCP_gsdat.csv", row.names = F)
write.csv(sidat, "./Results/OCP_sidat.csv", row.names = F)
```

```{r}
# Yield trial map widget --------------------------------------------------
w <- leaflet() %>% 
  addProviderTiles(providers$OpenStreetMap.Mapnik) %>%
  addCircleMarkers(si$lon, si$lat, clusterOptions = markerClusterOptions())
w ## plot widget 
saveWidget(w, 'OCP_trials.html', selfcontained = T) ## save widget
```

## Western Kenya One Acre Fund monitoring survey {WK-data}
